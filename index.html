<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Google AdSense Meta Tag -->
    <meta name="google-adsense-account" content="ca-pub-7198704920134124">
    
    <!-- Allow search engines to index -->
    <meta name="robots" content="index, follow">
    
    <!-- SEO Meta Tags -->
    <title>Frappy Ghost - Fun Ghost Adventure Game</title>
    <meta name="description" content="Play Frappy Ghost, a fun and addictive ghost adventure game. Guide your cute ghost through obstacles and try to beat the high scores!">
    <meta name="keywords" content="Frappy Ghost, ghost game, online game, browser game, arcade game, casual game">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://frappyghost.com/">
    <meta property="og:title" content="Frappy Ghost - Running Ghost With Frappe">
    <meta property="og:description" content="Play Frappy Ghost, a fun and addictive ghost adventure game. Guide your cute ghost through obstacles and try to beat the high scores!">
    <meta property="og:image" content="https://frappyghost.com/Elements/Thumbnail fg.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://frappyghost.com/">
    <meta property="twitter:title" content="Frappy Ghost - Running Ghost With Frappe">
    <meta property="twitter:description" content="Play Frappy Ghost, a fun and addictive ghost adventure game. Guide your cute ghost through obstacles and try to beat the high scores!">
    <meta property="twitter:image" content="https://frappyghost.com/Elements/Thumbnail fg.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="Elements/Frappy.png">
    
    <!-- Google AdSense Auto ads Code -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7198704920134124"
     crossorigin="anonymous"></script>
    
    <!-- Add Google Fonts -->
    <style>
        /* Remove these ad space styles */
        .game-wrapper,
        .ad-space,
        .ad-space p,
        .ad-space a {
            /* Delete these style blocks */
        }

        /* Keep the game container centered */
        .game-container {
            display: flex;
            justify-content: center;
            align-items: start;
            gap: 20px;
            padding-top: 20vh;
            padding-left: 20px;
            padding-right: 20px;
        }
        canvas {
            border: 4px solid #fff;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.5),
                        0 0 40px rgba(255, 105, 180, 0.3);
        }
        .high-scores {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 4px solid #fff;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.3);
            font-family: 'Press Start 2P', cursive;
            color: #fff;
        }
        .high-scores h2 {
            margin-top: 0;
            color: #ff69b4;
            text-shadow: 2px 2px 0px #000;
            font-size: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .score-list {
            list-style: none;
            padding: 0;
        }
        .score-list li {
            padding: 8px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            color: #fff;
            text-shadow: 1px 1px 0px #000;
        }
        body {
            background-color: #2c0138;  /* Dark purple background */
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            background-image: 
                linear-gradient(45deg, #3c015c 25%, transparent 25%),
                linear-gradient(-45deg, #3c015c 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #3c015c 75%),
                linear-gradient(-45deg, transparent 75%, #3c015c 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        /* Add this new style for the nyan cat image */
        #nyanCat {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        #backgroundImage {
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        /* Add retro font styling */
        .game-text {
            font-family: 'Press Start 2P', cursive;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
        }
        /* Keep high scores in regular font */
        .high-scores {
            font-family: Arial, sans-serif;
        }
        /* Add these new styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            border: 4px solid #ff69b4;
            text-align: center;
            z-index: 1001;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
        }

        .modal h2 {
            font-family: 'Press Start 2P', cursive;
            color: #ff69b4;
            font-size: 18px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #000;
        }

        .modal input {
            font-family: 'Press Start 2P', cursive;
            padding: 10px;
            margin: 10px 0;
            width: 200px;
            text-align: center;
            border: 2px solid #ff69b4;
            background: #000;
            color: #fff;
            text-shadow: 1px 1px 0px #000;
        }

        .modal button {
            font-family: 'Press Start 2P', cursive;
            padding: 10px 20px;
            margin: 10px;
            background: #ff69b4;
            border: 2px solid #fff;
            color: white;
            cursor: pointer;
            text-shadow: 1px 1px 0px #000;
            transition: all 0.2s ease;
        }

        .modal button:hover {
            background: #ff8cc6;
            transform: scale(1.05);
        }

        .modal button.cancel {
            background: #6a0dad;
        }
        
        .modal button.cancel:hover {
            background: #8b1bd4;
        }

        /* Remove these footer styles */
        .footer,
        .footer a,
        .footer a:hover {
            /* Delete these style blocks */
        }

        .game-instructions {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            color: white;
            font-family: 'Press Start 2P', cursive;
            text-align: center;
        }

        .game-instructions h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ff69b4;
            text-shadow: 2px 2px 0px #000;
        }

        .game-instructions ul {
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            border: 4px solid #fff;
            list-style-type: none;
            text-align: left;
            display: inline-block;
        }

        .game-instructions li {
            padding: 8px 0;
            font-size: 14px;
            line-height: 1.5;
        }

        .game-title {
            text-align: center;
            padding: 20px;
            margin-top: 80px;
            margin-bottom: -100px;  /* Adjust this to reduce space between title and game */
            color: #fff;
            font-family: 'Press Start 2P', cursive;
        }

        .game-title h1 {
            font-size: 48px;
            margin: 0;
            color: #ff69b4;
            text-shadow: 
                4px 4px 0px #000,
                -2px -2px 0px #000,
                2px -2px 0px #000,
                -2px 2px 0px #000;
        }

        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 40px;
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            font-family: 'Press Start 2P', cursive;
            font-size: 12px;
            color: #fff;
        }

        .footer a {
            color: #ff69b4;
            text-decoration: none;
            margin: 0 15px;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #ff8cc6;
            text-decoration: underline;
        }

        .footer-divider {
            color: rgba(255, 255, 255, 0.3);
            margin: 0 10px;
        }

        /* Mobile optimization styles */
        @media screen and (max-width: 768px) {
            .game-container {
                flex-direction: column;
                padding-top: 10vh;
                gap: 10px;
            }

            .game-title {
                margin-top: 20px;
                margin-bottom: -50px;
            }

            .game-title h1 {
                font-size: 32px;
            }

            .high-scores {
                width: 320px;
                margin: 0 auto;
            }

            .game-instructions {
                padding: 10px;
            }

            .game-instructions h2 {
                font-size: 18px;
            }

            .game-instructions ul {
                padding: 10px;
            }

            .game-instructions li {
                font-size: 12px;
            }

            .footer {
                font-size: 10px;
                padding: 10px;
            }

            .footer a {
                margin: 0 5px;
            }
        }

        /* Add these styles in the <style> section */
        .mobile-controls {
            display: none;  /* Hidden by default */
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .control-button {
            width: 40px;
            height: 40px;
            margin: 5px;
            border: 3px solid #fff;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
        }

        .control-button.active {
            background: #ff69b4;
        }

        /* Show controls only on mobile */
        @media screen and (max-width: 768px) {
            .mobile-controls {
                display: flex;
                flex-direction: column;
            }
        }

        @font-face {
            font-family: 'Press Start 2P';
            src: url('FONT Press 2P/PressStart2P-Regular.woff2') format('woff2'),
                 url('FONT Press 2P/PressStart2P-Regular.woff') format('woff'),
                 url('FONT Press 2P/PressStart2P-Regular.ttf') format('truetype');
            font-display: block;
            font-weight: normal;
            font-style: normal;
        }

        .score-tabs {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .tab-button {
            font-family: 'Press Start 2P', cursive;
            padding: 8px 15px;
            margin: 0 5px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #fff;
            color: #fff;
            cursor: pointer;
            font-size: 12px;
        }

        .tab-button.active {
            background: #ff69b4;
        }
    </style>
    <link rel="preload" href="FONT Press 2P/PressStart2P-Regular.woff2" as="font" type="font/woff2" crossorigin>
    <!-- Add these in the <head> section -->
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-database-compat.js"></script>

    <script>
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDPukoU3jTPlbXs_EzFL0tJBOJxZrJWUvk",
        authDomain: "frappy-ghost-2261b.firebaseapp.com",
        databaseURL: "https://frappy-ghost-2261b-default-rtdb.firebaseio.com",
        projectId: "frappy-ghost-2261b",
        storageBucket: "frappy-ghost-2261b.firebasestorage.app",
        messagingSenderId: "21698071950",
        appId: "1:21698071950:web:412557e4fc088ee58528df",
        measurementId: "G-EJC6F5PR9F"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
    </script>
</head>
<body>
    <!-- Update background image source to the new static image -->
    <img id="backgroundImage" src="Elements/NEW BG.png" style="display: none;">
    <img id="nyanCat" src="Elements/Frappy.png" style="display: none;">
    
    <!-- Audio elements -->
    <audio id="scoreSound" src="Soundeffect/scores.mp3"></audio>
    <audio id="gameOverSound" src="Soundeffect/Game over.mp3"></audio>
    <audio id="highScoreSound" src="Soundeffect/Highscores.mp3"></audio>
    <audio id="introMusic">
        <source src="Soundeffect/1st music.mp3" type="audio/mp3">
    </audio>
    <audio id="loopMusic" loop>
        <source src="Soundeffect/loop music.mp3" type="audio/mp3">
    </audio>

    <!-- Remove the game-info div from the top -->

    <!-- Update the structure to put instructions below -->
    <div class="game-title">
        <h1>Frappy Ghost</h1>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas" width="320" height="480"></canvas>
        <div class="high-scores">
            <h2>Top 5 High Scores</h2>
            <div class="score-tabs">
                <button class="tab-button active" onclick="showLocalScores()">Local</button>
                <button class="tab-button" onclick="showGlobalScores()">Global</button>
            </div>
            <ul id="scoreList" class="score-list">
                <!-- Scores will be inserted here -->
            </ul>
        </div>
    </div>

    <!-- Add instructions below the game -->
    <div class="game-instructions">
        <h2>How to Play</h2>
        <ul>
            <li>Press SPACE to make Frappy jump</li>
            <li>Avoid the pipes by navigating through them</li>
            <li>Each pipe passed equals one point</li>
            <li>Try to beat the high scores!</li>
            <li>Press M to toggle Sound ON/OFF</li>
            <li>Press B to toggle Music ON/OFF</li>
        </ul>
    </div>

    <!-- Add this HTML for the modal -->
    <div class="modal-overlay">
        <div class="modal">
            <h2>BOO!! NEW HIGHSCORE!!</h2>
            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="10">
            <div>
                <button onclick="submitScore()">Submit</button>
                <button class="cancel" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Add this HTML right after the canvas element -->
    <div class="mobile-controls">
        <button class="control-button active" id="soundToggle">🔊</button>
        <button class="control-button active" id="musicToggle">♪</button>
    </div>

    <script>
        // Replace with the original initialization
        let highScores = JSON.parse(localStorage.getItem('flappyHighScores')) || [];
        
        // Add background image reference
        const backgroundImage = document.getElementById('backgroundImage');
        const birdImage = document.getElementById('nyanCat');
        
        // Remove the onload handler since we're using an img element
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreList = document.getElementById('scoreList');

        // Sound elements
        const scoreSound = document.getElementById('scoreSound');
        const gameOverSound = document.getElementById('gameOverSound');
        const highScoreSound = document.getElementById('highScoreSound');
        let isSoundOn = true;

        // Add these with your other audio constants
        const introMusic = document.getElementById('introMusic');
        const loopMusic = document.getElementById('loopMusic');
        let isMusicOn = true;

        // Update bird properties
        const bird = {
            x: 50,
            y: 200,
            velocity: 0,
            gravity: 0.5,
            initialGravity: 0.2,  // New property for initial fall
            normalGravity: 0.5,   // Normal gravity value
            jump: -8,
            width: 40,
            height: 40,
            hasJumped: false      // New property to track first jump
        };

        // Pipe properties
        const pipes = [];
        const PIPE_WIDTH = 50;
        const PIPE_GAP = 150;
        const PIPE_SPEED = 2;

        let gameStarted = false;  // New variable to track if game has started
        let gameOver = false;
        let score = 0;

        // Add this after the other constant declarations
        const sparkles = [];  // Array to store sparkle particles

        // Add sparkle class
        class Sparkle {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 3 + 2;
                this.opacity = 1;
                this.color = this.getRandomColor();
            }

            getRandomColor() {
                const colors = ['#fff', '#ff0', '#f0f', '#0ff']; // White, yellow, pink, cyan
                return colors[Math.floor(Math.random() * colors.length)];
            }

            update() {
                this.opacity -= 0.02;  // Fade out
                this.x -= PIPE_SPEED;  // Move with the game speed
                this.y += (Math.random() - 0.5) * 2;  // Slight random vertical movement
            }

            draw(ctx) {
                ctx.save();
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        function playSound(sound) {
            if (isSoundOn) {
                sound.currentTime = 0;
                sound.play().catch(e => console.log("Sound play failed:", e));
            }
        }

        function updateHighScores(newScore) {
            if (newScore > 0 && isHighScore(newScore)) {
                playSound(highScoreSound);
                showHighScoreModal(newScore);
            }
        }

        function isHighScore(score) {
            if (score <= 0) return false;
            
            return highScores.length < 5 || score > highScores[highScores.length - 1].score;
        }

        // Add these variables at the top with your other variables
        let currentScoreView = 'local';

        // Add these with your other variables at the top
        const modalOverlay = document.querySelector('.modal-overlay');
        const playerNameInput = document.getElementById('playerNameInput');
        let pendingScore = 0;

        function showHighScoreModal(score) {
            pendingScore = score;
            modalOverlay.style.display = 'flex';
            playerNameInput.value = '';
            
            // Only auto-focus on desktop
            if (!isMobileDevice()) {
                playerNameInput.focus();
            }
            // Prevent scrolling of background when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Add these new functions
        function showLocalScores() {
            currentScoreView = 'local';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-button:first-child').classList.add('active');
            displayHighScores();
        }

        function showGlobalScores() {
            currentScoreView = 'global';
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-button:last-child').classList.add('active');
            loadGlobalScores();
        }

        function loadGlobalScores() {
            const scoresRef = firebase.database().ref('scores');
            scoresRef.orderByChild('score')
                .limitToLast(5)
                .once('value')
                .then((snapshot) => {
                    const scores = [];
                    snapshot.forEach((childSnapshot) => {
                        scores.unshift(childSnapshot.val());
                    });
                    
                    // Sort scores in descending order
                    scores.sort((a, b) => b.score - a.score);
                    
                    const scoreList = document.getElementById('scoreList');
                    scoreList.innerHTML = scores
                        .map((score, index) => `
                            <li>${index + 1}. ${score.name}: ${score.score}</li>
                        `)
                        .join('');
                })
                .catch(error => {
                    console.error("Error loading scores:", error);
                    // Show a fallback message if loading fails
                    scoreList.innerHTML = '<li>Unable to load global scores</li>';
                });
        }

        // Update the submitScore function
        function submitScore() {
            const playerName = playerNameInput.value.trim() || 'Ghost';
            if (pendingScore > 0) {
                // Save to local storage
                highScores.push({ name: playerName, score: pendingScore });
                highScores.sort((a, b) => b.score - a.score);
                highScores = highScores.slice(0, 5);
                localStorage.setItem('flappyHighScores', JSON.stringify(highScores));

                // Save to Firebase
                const scoresRef = firebase.database().ref('scores');
                scoresRef.push({
                    name: playerName,
                    score: pendingScore,
                    timestamp: Date.now()
                }).then(() => {
                    displayHighScores();
                    modalOverlay.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }).catch(error => {
                    console.error("Error saving score:", error);
                });
            }
        }

        // Update your existing displayHighScores function
        function displayHighScores() {
            const scoreList = document.getElementById('scoreList');
            if (currentScoreView === 'local') {
                scoreList.innerHTML = highScores
                    .map((score, index) => `
                        <li>${index + 1}. ${score.name}: ${score.score}</li>
                    `)
                    .join('');
            } else {
                loadGlobalScores();
            }
        }

        // Add this after the other constant declarations
        let screenShakeTime = 0;
        let screenShakeIntensity = 0;

        function startScreenShake(intensity = 5, duration = 300) {
            screenShakeTime = Date.now();
            screenShakeIntensity = intensity;
            setTimeout(() => {
                screenShakeTime = 0;
                screenShakeIntensity = 0;
                ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
            }, duration);
        }

        // Add death particles array
        let deathParticles = [];

        function createDeathEffect() {
            deathParticles = [];
            // Create explosion particles
            for(let i = 0; i < 20; i++) {
                deathParticles.push({
                    x: bird.x + bird.width/2,
                    y: bird.y + bird.height/2,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    size: Math.random() * 5 + 2,
                    opacity: 1,
                    color: '#ff69b4'  // Pink color to match theme
                });
            }
        }

        // Update the closeModal function
        function closeModal() {
            modalOverlay.style.display = 'none';
            // Re-enable scrolling when modal is closed
            document.body.style.overflow = 'auto';
        }

        // Update the canvas touch event listener
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();  // Prevent scrolling when touching the canvas
            
            if (!gameStarted) {
                gameStarted = true;
                resetGame();
                // Add this line to start music on first touch
                if (isMusicOn) {
                    playGameMusic();
                }
            } else if (gameOver) {
                resetGame();
            } else {
                bird.velocity = bird.jump;
                bird.hasJumped = true;
                bird.gravity = bird.normalGravity;
            }
        }, false);

        // Add this to prevent default touch behavior
        document.addEventListener('touchmove', function(e) {
            if (e.target == canvas) {
                e.preventDefault();
            }
        }, { passive: false });

        // Add jump handler function
        function handleJump() {
            if (!gameStarted) {
                gameStarted = true;
                resetGame();
            } else if (gameOver) {
                resetGame();
            } else {
                bird.velocity = bird.jump;
                bird.hasJumped = true;
                bird.gravity = bird.normalGravity;
            }
        }

        // Add particle effects for collisions
        // Add screen shake effects
        // Add smooth transitions between states
        function addVisualEffects() {
            // Screen shake when hitting pipes
            // Fade transitions for game over
            // Particle burst on collecting points
        }

        // Add music controls
        function toggleMusic() {
            isMusicOn = !isMusicOn;
            if (isMusicOn) {
                if (gameStarted) {
                    // If intro has already played, just start loop music
                    if (introMusic.ended) {
                        loopMusic.play().catch(e => console.log("Music play failed:", e));
                    } else {
                        playGameMusic();
                    }
                }
            } else {
                stopGameMusic();
            }
        }

        // Add music volume control (optional)
        introMusic.volume = 0.5;
        loopMusic.volume = 0.5;

        // Function to handle music chain
        function playGameMusic() {
            if (!isMusicOn) return;
            
            // Set up the music chain
            introMusic.play().catch(e => console.log("Music play failed:", e));
            
            // When intro ends, start the loop music
            introMusic.addEventListener('ended', () => {
                loopMusic.play().catch(e => console.log("Music play failed:", e));
            });
        }

        // Function to stop all music
        function stopGameMusic() {
            introMusic.pause();
            introMusic.currentTime = 0;
            loopMusic.pause();
            loopMusic.currentTime = 0;
        }

        // Add this function to detect mobile devices
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        // Also update the instructions text
        function updateInstructions() {
            const instructionsElement = document.querySelector('.game-instructions ul');
            const controlText = isMobileDevice() ? 'Tap screen to make Frappy jump' : 'Press SPACE to make Frappy jump';
            
            instructionsElement.innerHTML = `
                <li>${controlText}</li>
                <li>Avoid the pipes by navigating through them</li>
                <li>Each pipe passed equals one point</li>
                <li>Try to beat the high scores!</li>
                <li>Press M to toggle Sound ON/OFF</li>
                <li>Press B to toggle Music ON/OFF</li>
            `;
        }

        // Call this when the page loads
        updateInstructions();

        // Add these functions in your JavaScript section
        function updateButtonStates() {
            const soundButton = document.getElementById('soundToggle');
            const musicButton = document.getElementById('musicToggle');
            
            soundButton.className = `control-button ${isSoundOn ? 'active' : ''}`;
            soundButton.innerHTML = isSoundOn ? '🔊' : '🔈';
            
            musicButton.className = `control-button ${isMusicOn ? 'active' : ''}`;
            musicButton.innerHTML = isMusicOn ? '♪' : '♫';
        }

        // Add these event listeners after your other initialization code
        document.getElementById('soundToggle').addEventListener('click', function() {
            isSoundOn = !isSoundOn;
            updateButtonStates();
        });

        document.getElementById('musicToggle').addEventListener('click', function() {
            toggleMusic();
            updateButtonStates();
        });

        // Call this initially to set the correct state
        updateButtonStates();

        function resetGame() {
            bird.y = 200;
            bird.velocity = 0;
            bird.gravity = bird.initialGravity;  // Reset to initial gravity
            bird.hasJumped = false;  // Reset jump state
            pipes.length = 0;
            score = 0;
            gameOver = false;
            sparkles.length = 0;
            
            // Handle music on reset
            if (isMusicOn && gameStarted) {
                stopGameMusic();
                playGameMusic();
            }
            
            update();
        }

        function update() {
            if (!gameStarted) return;  // Don't update if game hasn't started
            if (gameOver) return;

            // Apply different gravity based on whether the bird has jumped
            if (!bird.hasJumped) {
                bird.velocity += bird.initialGravity;
            } else {
                bird.velocity += bird.gravity;
            }
            
            bird.y += bird.velocity;

            if (pipes.length === 0 || pipes[pipes.length - 1].x < canvas.width - 200) {
                createPipe();
            }

            for (let i = pipes.length - 1; i >= 0; i--) {
                pipes[i].x -= PIPE_SPEED;

                if (bird.x + bird.width > pipes[i].x && 
                    bird.x < pipes[i].x + PIPE_WIDTH &&
                    (bird.y < pipes[i].topHeight || 
                     bird.y + bird.height > pipes[i].bottomY)) {
                    gameOver = true;
                    playSound(gameOverSound);
                    startScreenShake();  // Add screen shake
                    createDeathEffect(); // Add death effect
                    updateHighScores(score);
                }

                if (pipes[i].x + PIPE_WIDTH < 0) {
                    pipes.splice(i, 1);
                    score++;
                    playSound(scoreSound);
                }
            }

            if (bird.y < 0 || bird.y + bird.height > canvas.height) {
                gameOver = true;
                playSound(gameOverSound);
                startScreenShake();  // Add screen shake
                createDeathEffect(); // Add death effect
                updateHighScores(score);
            }

            // Create new sparkles at Nyan Cat's position
            if (!gameOver) {
                sparkles.push(new Sparkle(
                    bird.x,
                    bird.y + bird.height/2
                ));
            }

            // Update and draw sparkles
            for (let i = sparkles.length - 1; i >= 0; i--) {
                sparkles[i].update();
                sparkles[i].draw(ctx);
                
                // Remove faded sparkles
                if (sparkles[i].opacity <= 0) {
                    sparkles.splice(i, 1);
                }
            }

            // Update death particles
            if (gameOver) {
                for (let i = deathParticles.length - 1; i >= 0; i--) {
                    const particle = deathParticles[i];
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    particle.vy += 0.2; // Add gravity to particles
                    particle.opacity -= 0.02;
                    
                    if (particle.opacity <= 0) {
                        deathParticles.splice(i, 1);
                    }
                }
            }

            draw();
            requestAnimationFrame(update);
        }

        function draw() {
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform

            // Apply screen shake if active
            if (screenShakeTime > 0) {
                const shakeX = Math.random() * screenShakeIntensity - screenShakeIntensity/2;
                const shakeY = Math.random() * screenShakeIntensity - screenShakeIntensity/2;
                ctx.translate(shakeX, shakeY);
            }

            // Draw background
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            if (!gameStarted) {
                // Draw start screen
                ctx.fillStyle = '#000';
                ctx.font = '32px "Press Start 2P"';
                for(let i = 4; i >= 0; i--) {
                    ctx.fillText('FRAPPY', canvas.width/2 - 80 + i, canvas.height/2 - 60 + i);
                }
                
                ctx.fillStyle = '#ff69b4';
                ctx.fillText('FRAPPY', canvas.width/2 - 80, canvas.height/2 - 60);

                // Change instruction based on device
                const startText = isMobileDevice() ? 'Tap screen' : 'Press SPACE';
                const startText2 = 'to begin!';
                
                // Remove flashing effect and use solid white color
                ctx.fillStyle = 'white';  // Changed from rgba with flashingRate
                ctx.font = '16px "Press Start 2P"';
                
                // Center the text
                const textWidth = ctx.measureText(startText).width;
                ctx.fillText(startText, canvas.width/2 - textWidth/2, canvas.height/2 + 20);
                
                const text2Width = ctx.measureText(startText2).width;
                ctx.fillText(startText2, canvas.width/2 - text2Width/2, canvas.height/2 + 50);

                // Draw nyan cat in center with slight bounce
                const bounce = Math.sin(Date.now() * 0.003) * 5;
                ctx.drawImage(birdImage, 
                    canvas.width/2 - bird.width/2,
                    canvas.height/2 - 120 + bounce,
                    bird.width,
                    bird.height
                );
            } else {
                // Draw regular game elements
                ctx.drawImage(birdImage, bird.x, bird.y, bird.width, bird.height);

                // Draw pipes
                pipes.forEach(pipe => {
                    // Colors for the pipe
                    const mainColor = '#45883f';     // Darker green
                    const highlightColor = '#6bc05c'; // Lighter green
                    const shadowColor = '#346b2f';    // Darkest green
                    
                    // Function to draw a pipe section
                    function drawPipeSection(x, y, height, isTop) {
                        // Main pipe body
                        ctx.fillStyle = mainColor;
                        ctx.fillRect(x, y, PIPE_WIDTH, height);
                        
                        // Pipe head (larger section at end)
                        const headHeight = 30;
                        const headWidth = 60;
                        const headX = x - (headWidth - PIPE_WIDTH) / 2;
                        const headY = isTop ? height - headHeight + y : y;
                        
                        // Main head section
                        ctx.fillStyle = mainColor;
                        ctx.fillRect(headX, headY, headWidth, headHeight);
                        
                        // Highlight
                        ctx.fillStyle = highlightColor;
                        ctx.fillRect(headX + 2, headY + (isTop ? 2 : 0), 3, headHeight - 2);
                        ctx.fillRect(x + 2, y + (isTop ? 0 : 2), 3, height - 2);
                        
                        // Shadow
                        ctx.fillStyle = shadowColor;
                        ctx.fillRect(headX + headWidth - 5, headY + 2, 3, headHeight - 2);
                        ctx.fillRect(x + PIPE_WIDTH - 5, y + 2, 3, height - 2);
                    }

                    // Draw top pipe
                    drawPipeSection(pipe.x, 0, pipe.topHeight, true);
                    
                    // Draw bottom pipe
                    drawPipeSection(pipe.x, pipe.bottomY, canvas.height - pipe.bottomY, false);
                });

                // Draw score only (remove sound status)
                ctx.fillStyle = 'white';
                ctx.font = '16px "Press Start 2P"';
                ctx.fillText(`Score: ${score}`, 10, 30);

                if (gameOver) {
                    ctx.fillStyle = 'white';
                    ctx.font = '24px "Press Start 2P"';
                    ctx.fillText('Game Over!', canvas.width/2 - 100, canvas.height/2);
                    ctx.font = '12px "Press Start 2P"';
                    
                    // Change restart message based on device
                    const restartText = isMobileDevice() ? 
                        'Tap screen to restart' : 
                        'Press SPACE to restart';
                    
                    // Center the text based on its length
                    const textWidth = ctx.measureText(restartText).width;
                    ctx.fillText(restartText, canvas.width/2 - textWidth/2, canvas.height/2 + 40);
                }

                // Draw death particles
                if (gameOver && deathParticles.length > 0) {
                    deathParticles.forEach(particle => {
                        ctx.save();
                        ctx.fillStyle = particle.color;
                        ctx.globalAlpha = particle.opacity;
                        ctx.beginPath();
                        ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    });
                }
            }
        }

        // Start the game loop but don't start the game
        displayHighScores();
        update();
        requestAnimationFrame(draw);  // Keep drawing even when game hasn't started
    </script>

    <footer class="footer">
        <a href="mailto:eldorandom@gmail.com">Contact</a>
        <span class="footer-divider">|</span>
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://frappyghost.com/" target="_blank">Facebook</a>
        <span class="footer-divider">|</span>
        <a href="https://twitter.com/intent/tweet?url=https://frappyghost.com/&text=Play%20Frappy%20Ghost%20-%20A%20fun%20ghost%20adventure%20game!" target="_blank">Twitter</a>
    </footer>
</body>
</html>
